name: Deploy to Azure Container Apps (Production)

on:
  push:
    branches:
      - main
    paths:
      - 'app.js'
      - 'package.json'
      - 'package-lock.json'
      - 'Dockerfile'
      - '.dockerignore'
      - 'src/**'
      - 'lib/**'
      - 'config/**'
      - '.github/workflows/deploy-production.yml'
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - 'terraform/**'
      - '*.md'
      - '.gitignore'
      - 'LICENSE'

permissions:
  id-token: write # Federated Identity 用
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      ACR_NAME: slackbotacaacr
      IMAGE_NAME: slackbot-sample
      CONTAINER_APP_NAME: slackbot-sample-app
      RESOURCE_GROUP: rg-slackbot-aca-cli
      KEY_VAULT_NAME: kv-slackbot-aca-cli

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Azure using Federated Identity
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get next version tag from ACR
        id: version
        run: |
          # 既存のタグ一覧を取得
          TAGS=$(az acr repository show-tags \
            --name ${{ env.ACR_NAME }} \
            --repository ${{ env.IMAGE_NAME }} \
            --orderby time_desc \
            --output tsv 2>/dev/null || echo "")

          if [ -z "$TAGS" ]; then
            # タグが存在しない場合は v1 から開始
            NEXT_VERSION="1"
          else
            # 最新のタグから次のバージョンを計算
            LATEST_TAG=$(echo "$TAGS" | head -n 1)
            LATEST_VERSION=$(echo $LATEST_TAG | sed 's/v//' | sed 's/[^0-9]*//g')
            NEXT_VERSION=$((LATEST_VERSION + 1))
          fi

          echo "next_version=$NEXT_VERSION" >> $GITHUB_OUTPUT
          echo "Next version: v$NEXT_VERSION"

      - name: Log in to Azure Container Registry (Managed Identity)
        run: |
          az acr login --name ${{ env.ACR_NAME }}

      - name: Build and push Docker image
        run: |
          VERSION=${{ steps.version.outputs.next_version }}
          IMAGE_TAG="${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:v${VERSION}"
          IMAGE_LATEST="${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest"

          docker build -t $IMAGE_TAG -t $IMAGE_LATEST .
          docker push $IMAGE_TAG
          docker push $IMAGE_LATEST

          echo "Pushed image: $IMAGE_TAG"
          echo "Pushed image: $IMAGE_LATEST"

      - name: Update Container App
        run: |
          VERSION=${{ steps.version.outputs.next_version }}
          IMAGE_TAG="${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:v${VERSION}"

          az containerapp update \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image $IMAGE_TAG \
            --output table

      - name: Verify deployment
        run: |
          echo "Deployment completed successfully!"
          echo "Image: ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:v${{ steps.version.outputs.next_version }}"

          # Container App の状態確認
          az containerapp show \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "properties.{ProvisioningState:provisioningState, RunningStatus:runningStatus, LatestRevision:latestRevisionName}" \
            --output table
